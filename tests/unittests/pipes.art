; A simple pipe
2 | print

; ...should be equivalent to:
print 2

; A tiny-bit more complicated pipe
2 | add 3 | print

; And a pipe split in different lines
2 | add 3
  | print

; ...should both be equivalent to:
print add 2 3

; Something even more complicated
["one" "two"] | map 'x [upper x]
              | print

; ...should be equivalent to:
print map ["one" "two"] 'x -> upper x

; Let's level up
1..10 | map 'x -> 2*x
      | print

; ...should be equivalent to:
print map 1..10 'x -> 2*x

; And a bit more
1..10 | map 'x [3*x]
      | select 'x [odd? x]
      | print

; ...should be equivalent to:
print select map 1..10 'x [3*x] 'x [odd? x]

; With assignment
z: 2 | add 3 | sub 1
print z

; ...should be equivalent to:
z: 2 | add 3
     | sub 1
print z

; ...and also to:
z: sub add 2 3 1
print z

;-----------------------------------------------------------------------------
testNo: 0
section: function [topic].inline[
      testNo: 0
      print ["\n>>" topic]
]

; what's the best way to verify the pipe transformations work, 
; other than that they produce the exact same bytecode
; as the "normal" code?! :)
check: function [block1 block2].inline[
      testNo: testNo + 1
      ensure -> equal?
            to.intrepid :bytecode block1
            to.intrepid :bytecode block2
      print [pad to :string testNo 2 ": [+] passed!"]
]

section "Simple call with one param"

      check [print 2] [2 | print]
      ; also check the exact same thing
      ; only with newlines in between; you never know...
      check [
            print 2
      ][
            2 | 
            print
      ]
      check [
            print
            2
      ][
            2 
            | 
            print
      ]
      check [
            print "before"
            print 2
            print "after"
      ][
            print "before"
            2 | print
            print "after"
      ]

section "Simple call with two params"

      check [add 2 x] [2 | add x]
      check [
            add 2 x
      ][
            2 | add x
      ]
      check [
            add 2 x
      ][
            2 
            | add x
      ]
      check [
            add
            2
            x
      ][
            2 
            | 
            add x
      ]
      check [
            print "before"
            add 2 x
            print "after"
      ][
            print "before"
            2 | add x
            print "after"
      ]

section "Assignment with an one-param call"

      check [x: even? 2][x: 2 | even?]
      check [
            x: even? 2
      ][
            x:
            2 | even?
      ]
      check [
            x: even? 2
      ][
            x: 2 
            | even?
      ]
      check [
            x: even? 2
      ][
            x: 2 
            | 
            even?
      ]
      check [
            print "before"
            x: even? 2
            print "after"
      ][
            print "before"
            x: 2 | even?
            print "after"
      ]

section "Assignment with a two-param call"

      check [x: add 2 z][x: 2 | add z]
      check [
            x: add 2 z
      ][
            x:
            2 | add z
      ]
      check [
            x: add 2 z
      ][
            x: 2 
            | add z
      ]
      check [
            x: add 2 z
      ][
            x: 2 
            | 
            add z
      ]
      check [
            print "before"
            x: add 2 z
            print "after"
      ][
            print "before"
            x: 2 | add z
            print "after"
      ]

section "Call as initial argument"

      check [print 1..3][1..3 | print]
      check [
            print 1..3
      ][
            1..3 | print
      ]
      check [
            print 1..3
      ][
            1..3 
            | print
      ]
      check [
            print 1..3
      ][
            1..3 
            | 
            print
      ]
      check [
            print "before"
            print 1..3
            print "after"
      ][
            print "before"
            1..3 | print
            print "after"
      ]

section "Assignment with call as initial argument"

      check [x: max 1..10][x: 1..10 | max]
      check [
            x: max 1..10
      ][
            x:
            1..10 | max
      ]
      check [
            x: max 1..10
      ][
            x: 1..10 
            | max
      ]
      check [
            x: max 1..10
      ][
            x: 1..10 
            | 
            max
      ]
      check [
            print "before"
            x: max 1..10
            print "after"
      ][
            print "before"
            x: 1..10 | max
            print "after"
      ]

section "Pipes + Attributes"

      check [split.words "hello world"]["hello world" | split.words]
      check [
            split.words "hello world"
      ][
            "hello world" | split.words
      ]
      check [
            split.words "hello world"
      ][
            "hello world" 
            | split.words
      ]
      check [
            split.words "hello world"
      ][
            "hello world" 
            | 
            split.words
      ]
      check [
            print "before"
            split.words "hello world"
            print "after"
      ][
            print "before"
            "hello world" | split.words
            print "after"
      ]